<div class="app-shell">
  <header class="topbar">
    <div class="brand">
      <img src="assets/la-favorita.svg" alt="La Favorita" class="brand-logo" />
      <div class="brand-text">
        <span class="brand-kicker">Portal de alianzas estratégicas</span>
        <span class="brand-title">La Favorita & ONG</span>
      </div>
    </div>
    <nav class="top-actions">
      <button type="button" class="ghost" (click)="switchRole('ONG')">Flujo ONG</button>
      <button type="button" class="ghost" (click)="switchRole('Favorita')">Flujo La Favorita</button>
      @if (isAuthenticated()) {
        <button type="button" class="outline" (click)="logout()">Cerrar sesión</button>
      }
    </nav>
  </header>

  <main class="main-content">
    @if (!isAuthenticated()) {
      <section class="login-area">
        <div class="login-hero">
          <div class="login-gradient"></div>
          <div class="login-copy">
            <h1>Conecta iniciativas de impacto con el ecosistema La Favorita</h1>
            <p>
              Prototipo de interfaz responsiva para gestionar proyectos sociales, hacer seguimiento
              de objetivos específicos y monitorear presupuestos en tiempo real.
            </p>
            <ul class="feature-list">
              <li>Autenticación con roles diferenciados para ONG y equipo La Favorita.</li>
              <li>Panel de proyectos con objetivos, actividades, KPI y seguimiento temporal.</li>
              <li>Gestión granular de presupuestos, estados de solicitudes y documentación.</li>
            </ul>
          </div>
        </div>
        <form class="login-form" (ngSubmit)="login()">
          <h2>Ingreso seguro</h2>
          <p class="form-subtitle">
            Demostración de captura de credenciales y asignación de tokens por rol.
          </p>
          <label class="field">
            <span>Correo institucional</span>
            <input type="email" name="email" required [(ngModel)]="loginModel.email" placeholder="nombre@tuong.org" />
          </label>
          <label class="field">
            <span>Contraseña</span>
            <input
              type="password"
              name="password"
              required
              [(ngModel)]="loginModel.password"
              placeholder="Ingresa tu clave"
            />
          </label>
          <div class="field role-selector">
            <span>Selecciona tu rol</span>
            <div class="role-pills">
              <label class="role-pill" [class.active]="loginModel.role === 'ONG'">
                <input type="radio" name="role" value="ONG" [(ngModel)]="loginModel.role" />
                ONG aliada
              </label>
              <label class="role-pill" [class.active]="loginModel.role === 'Favorita'">
                <input type="radio" name="role" value="Favorita" [(ngModel)]="loginModel.role" />
                Corporación La Favorita
              </label>
            </div>
          </div>
          <button type="submit" class="primary">Ingresar al portal</button>
          <div class="token-hint">
            <h3>¿Cómo funciona el token?</h3>
            <p>
              Una vez autenticada la cuenta, se genera un token único por rol para consumir servicios
              del ecosistema. Aquí se muestra una vista previa del formato esperado.
            </p>
            <div class="token-preview">{{ loginModel.role === 'ONG' ? 'ONG-FA-TOKEN-2025-LAF' : 'FAVORITA-PORTAL-2025' }}</div>
          </div>
        </form>
      </section>
    } @else {
      @if (selectedRole() === 'ONG') {
        <section class="dashboard">
          <aside class="profile-panel">
            <div class="profile-card">
              <h2>Perfil de la ONG</h2>
              <p class="profile-summary">{{ organizationProfile.summary }}</p>
              <dl>
                <div>
                  <dt>Representante</dt>
                  <dd>{{ organizationProfile.contact }}</dd>
                </div>
                <div>
                  <dt>Correo</dt>
                  <dd>{{ organizationProfile.email }}</dd>
                </div>
                <div>
                  <dt>Teléfono</dt>
                  <dd>{{ organizationProfile.phone }}</dd>
                </div>
                <div>
                  <dt>Dirección</dt>
                  <dd>{{ organizationProfile.address }}</dd>
                </div>
              </dl>
              <div class="token-card">
                <span>Token activo</span>
                <strong>{{ authToken() }}</strong>
                <p>Utilízalo para acceder a APIs seguras y reportes en tiempo real.</p>
              </div>
            </div>
            <div class="insights">
              <div class="insight">
                <span class="insight-value">{{ projects.length }}</span>
                <span class="insight-label">Proyectos vigentes</span>
              </div>
              <div class="insight">
                <span class="insight-value">
                  {{ (projects.length + 1) | number: '1.0-0' }}
                </span>
                <span class="insight-label">Propuestas listas</span>
              </div>
              <div class="insight">
                <span class="insight-value">{{ totalManagedAmount | currency: 'USD':'symbol':'1.0-0' }}</span>
                <span class="insight-label">Monto gestionado</span>
              </div>
            </div>
          </aside>
          <section class="projects-section">
            <div class="section-header">
              <div>
                <h2>Mis proyectos</h2>
                <p>Selecciona un proyecto para revisar objetivos, actividades, KPI y presupuesto.</p>
              </div>
              <button type="button" class="outline">Crear nuevo proyecto</button>
            </div>
            <div class="project-grid">
              @for (project of projects; track project.id) {
                <article
                  class="project-card"
                  [class.active]="selectedProject()?.id === project.id"
                  (click)="viewProject(project.id)"
                >
                  <header>
                    <span class="project-code">{{ project.code }}</span>
                    <h3>{{ project.name }}</h3>
                    <p>{{ project.shortDescription }}</p>
                  </header>
                  <div class="project-meta">
                    <div>
                      <span>Alcance</span>
                      <strong>{{ project.reach }}</strong>
                    </div>
                    <div>
                      <span>Monto</span>
                      <strong>{{ project.amount | currency: 'USD':'symbol':'1.0-0' }}</strong>
                    </div>
                    <div>
                      <span>Plazo</span>
                      <strong>{{ project.timeline.months }} meses</strong>
                    </div>
                  </div>
                  <div class="axes">
                    @for (axis of project.axes; track axis) {
                      <span class="axis-chip">{{ axis }}</span>
                    }
                  </div>
                </article>
              }
            </div>

            @if (selectedProject(); as project) {
              <section class="project-detail">
                <header class="project-detail-header">
                  <div>
                    <h2>{{ project.name }}</h2>
                    <p>{{ project.generalObjective }}</p>
                  </div>
                  <div class="detail-highlight">
                    <div>
                      <span>Inicio</span>
                      <strong>{{ project.timeline.start }}</strong>
                    </div>
                    <div>
                      <span>Fin</span>
                      <strong>{{ project.timeline.end }}</strong>
                    </div>
                    <div>
                      <span>Resultado esperado</span>
                      <strong>{{ project.result }}</strong>
                    </div>
                  </div>
                </header>

                <div class="objective-tabs">
                  @for (objective of project.specificObjectives; track objective.id) {
                    <button
                      type="button"
                      class="objective-tab"
                      [class.active]="selectedObjective()?.id === objective.id"
                      (click)="viewObjective(objective.id)"
                    >
                      {{ objective.title }}
                      <span>
                        @for (axis of objective.axes; track axis) {
                          <span class="axis-chip">{{ axis }}</span>
                        }
                      </span>
                    </button>
                  }
                </div>

                @if (selectedObjective(); as objective) {
                  <div class="objective-panel">
                    <div class="objective-description">
                      <h3>Objetivo específico seleccionado</h3>
                      <p>{{ objective.description }}</p>
                    </div>
                    <div class="activities-grid">
                      @for (activity of objective.activities; track activity.id) {
                        <article class="activity-card">
                          <header>
                            <div>
                              <h4>{{ activity.name }}</h4>
                              <span class="activity-category">{{ activity.category }}</span>
                            </div>
                            <div class="activity-kpi" [attr.data-trend]="activity.kpi.trend">
                              <span>{{ activity.kpi.title }}</span>
                              <strong>{{ activity.kpi.value }}</strong>
                              <small>{{ activity.kpi.description }}</small>
                              <span class="kpi-status" [class]="activity.kpi.status.toLowerCase().replace(' ', '-')">
                                {{ activity.kpi.status }}
                              </span>
                            </div>
                          </header>
                          <div class="activity-body">
                            <div>
                              <span>Resultado esperado</span>
                              <p>{{ activity.expectedResult }}</p>
                            </div>
                            <div>
                              <span>Resultado obtenido</span>
                              <p>{{ activity.obtainedResult }}</p>
                            </div>
                          </div>
                          <div class="activity-periods">
                            @for (period of activity.periods; track period.label) {
                              <div class="period-pill">
                                <span>{{ period.label }}</span>
                                <strong>{{ period.start }} → {{ period.end }}</strong>
                              </div>
                            }
                          </div>
                        </article>
                      }
                    </div>
                  </div>
                }

                <div class="budget-section">
                  <div class="section-header">
                    <div>
                      <h3>Presupuesto detallado</h3>
                      <p>Cada rubro se gestiona de forma independiente dentro del proyecto.</p>
                    </div>
                    <div class="budget-total">
                      Total: {{ getBudgetTotal(project) | currency: 'USD':'symbol':'1.0-0' }}
                    </div>
                  </div>
                  <div class="budget-table">
                    <div class="budget-table-header">
                      <span>Categoría</span>
                      <span>Detalle</span>
                      <span>Cantidad</span>
                      <span>Unidad</span>
                      <span>Valor unitario</span>
                      <span>Total</span>
                    </div>
                    @for (item of project.budget; track item.item) {
                      <div class="budget-row">
                        <span>{{ item.category }}</span>
                        <span>{{ item.item }}</span>
                        <span>{{ item.quantity }}</span>
                        <span>{{ item.units }}</span>
                        <span>{{ item.value | currency: 'USD':'symbol':'1.2-2' }}</span>
                        <span>{{ (item.quantity * item.value) | currency: 'USD':'symbol':'1.2-2' }}</span>
                      </div>
                    }
                  </div>
                </div>

                <div class="budget-request">
                  <div class="request-info">
                    <h3>Solicitud de presupuesto</h3>
                    <p>{{ project.budgetRequest.note }}</p>
                    <div class="document-pill">
                      <span aria-hidden="true">📄</span>
                      {{ project.budgetRequest.document }}
                    </div>
                  </div>
                  <div class="request-status" [class]="statusToBadge(project.budgetRequest.status)">
                    <span>Estado</span>
                    <strong>{{ project.budgetRequest.status }}</strong>
                    <small>Actualizado el {{ project.budgetRequest.updatedAt }}</small>
                    <button type="button" class="outline">Subir nuevo respaldo</button>
                  </div>
                </div>
              </section>
            }
          </section>
        </section>
      } @else {
        <section class="favorita-dashboard">
          <header class="section-header">
            <div>
              <h2>Panel La Favorita</h2>
              <p>
                Visualiza solicitudes entrantes, estados de revisión y próximas acciones para
                fortalecer alianzas con las ONG.
              </p>
            </div>
            <button type="button" class="primary">Crear convocatoria</button>
          </header>

          <div class="review-metrics">
            <div class="metric-card">
              <span>Solicitudes activas</span>
              <strong>{{ favoritaReviews.length }}</strong>
            </div>
            <div class="metric-card">
              <span>Monto total en revisión</span>
              <strong>{{ totalRequestedAmount | currency: 'USD':'symbol':'1.0-0' }}</strong>
            </div>
            <div class="metric-card">
              <span>En revisión</span>
              <strong>{{ reviewRequests }}</strong>
            </div>
            <div class="metric-card">
              <span>Aprobadas</span>
              <strong>{{ approvedRequests }}</strong>
            </div>
          </div>

          <div class="review-board">
            @for (request of favoritaReviews; track request.id) {
              <article class="review-card" [class]="statusToBadge(request.status)">
                <header>
                  <div>
                    <span class="request-id">{{ request.id }}</span>
                    <h3>{{ request.project }}</h3>
                  </div>
                  <span class="status-pill">{{ request.status }}</span>
                </header>
                <div class="review-body">
                  <div>
                    <span>ONG</span>
                    <strong>{{ request.ong }}</strong>
                  </div>
                  <div>
                    <span>Monto solicitado</span>
                    <strong>{{ request.amount | currency: 'USD':'symbol':'1.0-0' }}</strong>
                  </div>
                  <div>
                    <span>Fecha de ingreso</span>
                    <strong>{{ request.submittedAt }}</strong>
                  </div>
                </div>
                <p class="next-step">{{ request.nextStep }}</p>
                <footer>
                  <span>Responsable: {{ request.reviewer }}</span>
                  <div class="review-actions">
                    <button type="button" class="ghost">Ver expediente</button>
                    <button type="button" class="outline">Enviar observaciones</button>
                    <button type="button" class="primary">Aprobar</button>
                  </div>
                </footer>
              </article>
            }
          </div>
        </section>
      }
    }
  </main>

  <footer class="footer">
    <div>
      <strong>Corporación La Favorita</strong>
      <p>Interfaz conceptual para el portal de colaboración con organizaciones sociales en Ecuador.</p>
    </div>
    <div class="footer-links">
      <a href="mailto:responsabilidadsocial@lafavorita.ec">responsabilidadsocial@lafavorita.ec</a>
      <span>•</span>
      <span>Quito - Guayaquil - Cuenca</span>
    </div>
  </footer>
</div>
